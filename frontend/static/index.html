<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SourceSense</title>
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="https://atlan.com/favicon-96x96.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="https://atlan.com/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="https://atlan.com/favicon-16x16.png"
    />
    <link rel="stylesheet" href="styles.css?v=3" />
    <!-- Mermaid for client-side diagram rendering -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
      // Initialize Mermaid but don't auto-scan the whole page
      if (window.mermaid) { try { mermaid.initialize({ startOnLoad: false, theme: 'default' }); } catch(_){} }
    </script>
    <style>
      /* Landing hero overlay (isolated styles, no impact on app) */
      #landing-hero { position: fixed; inset: 0; z-index: 9999; display: grid; place-items: center; background:
          radial-gradient(1200px 800px at 20% -10%, rgba(96,165,250,.15), transparent 60%),
          radial-gradient(1000px 700px at 120% 20%, rgba(34,211,238,.12), transparent 60%),
          linear-gradient(180deg, #0b1220 0%, #0f172a 60%, #111827 100%);
        color: #e5e7eb; transition: opacity .35s ease, transform .35s ease; }
      #landing-hero.hide { opacity: 0; transform: scale(0.98); pointer-events: none; }
      #landing-hero .content { text-align: center; padding: 60px 20px; max-width: 960px; }
      #landing-hero .logo { width: 60px; height: 60px; border-radius: 16px; display: grid; place-items: center; margin: 0 auto 12px; background: linear-gradient(135deg, rgba(96,165,250,.25), rgba(34,211,238,.25)); border: 1px solid rgba(255,255,255,.1); }
      #landing-hero .logo img { width: 36px; height: 36px; filter: drop-shadow(0 6px 10px rgba(0,0,0,.25)); }
      #landing-hero .badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border: 1px solid rgba(255,255,255,.08); border-radius: 999px; background: rgba(255,255,255,.04); color: #94a3b8; font-size: 12px; letter-spacing: .02em; }
      #landing-hero .title { margin-top: 16px; font-size: clamp(36px, 7vw, 60px); line-height: 1.05; font-weight: 700; letter-spacing: -0.02em; background: linear-gradient(90deg, #fff, #c7d2fe 40%, #7dd3fc 80%); -webkit-background-clip: text; background-clip: text; color: transparent; }
      #landing-hero .subtitle { margin: 12px auto 22px; max-width: 720px; color: #94a3b8; font-size: clamp(14px, 2.2vw, 18px); }
      #landing-hero .byline { margin-top: 4px; color: #cbd5e1; font-size: 14px; }
      #landing-hero .actions { margin-top: 26px; display: flex; justify-content: center; gap: 14px; }
      #landing-hero .btn { appearance: none; border: 0; background: #293c54; color: #fff; padding: 12px 18px; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; transition: transform .08s ease, background .2s ease, box-shadow .2s ease; box-shadow: 0 10px 30px rgba(17,24,39,.25), inset 0 1px 0 rgba(255,255,255,.05); text-decoration: none; display: inline-flex; align-items: center; gap: 10px; }
      #landing-hero .btn:hover { background: #36465a; transform: translateY(-1px); }
      #landing-hero footer { margin-top: 36px; color: #94a3b8; font-size: 12px; }
    </style>
  </head>
  <body>
    <script>
      window.env = {
        APP_HTTP_HOST: location.hostname,
        APP_HTTP_PORT: location.port || "3000",
        APP_DASHBOARD_HTTP_HOST: location.hostname,
        APP_DASHBOARD_HTTP_PORT: location.port || "3000",
        TENANT_ID: "default",
        APP_NAME: "postgres",
        TEMPORAL_UI_HOST: location.hostname,
        TEMPORAL_UI_PORT: "8233",
        // Optional: shared Google Doc URL for credentials
        // Example: "https://docs.google.com/document/d/XXXXXX/edit"
        CREDS_DOC_URL: "https://docs.google.com/document/d/1XSHt6ZqrX2BufmzgbXA5I0K1bLpkPFGUfSAOYImq-gg/edit?usp=sharing",
        // Ordered candidate models for Groq; customize as needed
        // Default to gemma2-9b-it (good results), with a small fallback
        LLM_MODELS: "gemma2-9b-it,llama-3.1-8b-instant",
      };
    </script>

    <!-- Elegant landing hero overlay (non-intrusive) -->
    <div id="landing-hero" role="dialog" aria-modal="true">
      <div class="content" aria-labelledby="hero-title">
        <div class="logo">
          <img src="https://cdn-icons-png.flaticon.com/512/5968/5968342.png" alt="Postgres" />
        </div>
        <span class="badge">Welcome to</span>
        <h1 id="hero-title" class="title">SourceSense</h1>
        <p class="subtitle">A clean, elegant starting point for exploring your Postgres metadata.</p>
        <div class="byline">By Tanish Khot</div>
        <div class="actions">
          <a id="enter-app" class="btn" href="#">Take me to the postgres connector</a>
        </div>
        <footer>Press Enter or click the button to continue.</footer>
      </div>
    </div>

    <div class="container">
      <header class="header">
        <div class="logo-container">
          <img
            src="https://cdn-icons-png.flaticon.com/512/5968/5968342.png"
            alt="Postgres Logo"
            class="logo"
            width="64"
            height="64"
          />
          <h1>Postgres Connector</h1>
        </div>
      </header>

      <div class="main-content">
        <div class="sidebar">
          <div class="step-list">
            <div class="step active" data-step="1" onclick="goToPage(1)">
              <div class="step-indicator">1</div>
              <span>Credential</span>
            </div>
            <div class="step" data-step="2" onclick="goToPage(2)">
              <div class="step-indicator">2</div>
              <span>Connection</span>
            </div>
            <div class="step" data-step="3" onclick="goToPage(3)">
              <div class="step-indicator">3</div>
              <span>Metadata</span>
            </div>
            <div class="step" data-step="4" onclick="goToPage(4)">
              <div class="step-indicator">4</div>
              <span>Results</span>
            </div>
          </div>
        </div>

        <div class="form-container">
          <div id="page1" class="page active">
            <div class="form-group">
              <label>Connection URL (optional)</label>
              <div style="display: flex; gap: 8px; align-items: center">
                <input
                  type="text"
                  id="connUrl"
                  placeholder="postgresql://user:pass@host:5432/db?sslmode=require"
                  style="flex: 1"
                />
                <button type="button" id="parseUrl" class="btn btn-secondary">
                  Parse URL
                </button>
              </div>
            </div>
            <div class="form-group" style="display:flex; align-items:center; gap:8px;">
              <a id="getCredsLink" class="btn btn-outline" href="#" target="_blank" rel="noopener noreferrer">
                Get the credentials
              </a>
              <span class="hint">Opens the shared Google Doc</span>
            </div>
            <div class="form-group horizontal">
              <div class="input-wrapper flex-grow">
                <label>Host *</label>
                <input type="text" id="host" placeholder="localhost" />
              </div>
              <div class="input-wrapper" style="width: 100px">
                <label>Port *</label>
                <input type="text" id="port" value="5432" />
              </div>
            </div>

            <div class="form-group horizontal">
              <div class="input-wrapper flex-half">
                <label>Username *</label>
                <input type="text" id="username" value="postgres" />
              </div>
              <div class="input-wrapper flex-half">
                <label>Password *</label>
                <div style="display: flex; gap: 8px; align-items: center">
                  <input
                    type="password"
                    id="password"
                    placeholder="Password"
                    style="flex: 1"
                  />
                  <button
                    type="button"
                    id="togglePassword"
                    class="btn btn-secondary"
                    style="white-space: nowrap"
                  >
                    Show
                  </button>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label>
                <input type="checkbox" id="requireSSL" /> Require SSL
                <span class="help-icon" title=""
                  >You need SSL for: Neon, AWS RDS, GCP Cloud SQL (and most
                  cloud Postgres). This sets sslmode=require so the driver
                  negotiates TLS and avoids authentication or connection
                  failures. <br />
                  If that did not work, uncheck the tickbox and move on.</span
                >
              </label>
            </div>
            <div class="form-group">
              <label
                >SSL Mode
                <span
                  class="help-icon"
                  title="You need SSL for: Neon, AWS RDS, Cloud SQL. Use require for most cases; use verify-ca/verify-full when you must verify the server certificate with your own CA."
                  ></span
                ></label
              >
              <select id="sslmode">
                <option value="">(default)</option>
                <option value="disable">disable</option>
                <option value="allow">allow</option>
                <option value="prefer">prefer</option>
                <option value="require">require</option>
                <option value="verify-ca">verify-ca</option>
                <option value="verify-full">verify-full</option>
              </select>
            </div>

            <div class="form-group">
              <label>Database *</label>
              <input type="text" id="database" value="postgres" />
            </div>

            <button
              class="btn btn-outline test-connection"
              onclick="testConnection()"
            >
              Test Connection
            </button>
            <div class="error-message" id="connectionError"></div>

            <div class="bottom-bar">
              <div id="page1-nav" class="nav-buttons">
                <button
                  id="nextButton"
                  onclick="nextPage()"
                  class="btn btn-primary"
                  disabled
                >
                  Next
                </button>
              </div>
            </div>
          </div>

          <div id="page2" class="page">
            <div class="form-group">
              <label>Connection Name *</label>
              <input
                type="text"
                id="connectionName"
                placeholder="postgres-conn"
              />
            </div>
            <div class="bottom-bar">
              <div id="page2-nav" class="nav-buttons">
                <button onclick="previousPage()" class="btn btn-secondary">
                  Previous
                </button>
                <button onclick="nextPage()" class="btn btn-primary">
                  Next
                </button>
              </div>
            </div>
          </div>

          <div id="page3" class="page">
            <div class="metadata-grid">
              <div class="form-group">
                <label>Exclude Metadata</label>
                <div class="metadata-dropdown" id="excludeMetadata">
                  <div
                    class="dropdown-header"
                    onclick="toggleDropdown('excludeMetadata')"
                  >
                    <span>Select databases and schemas</span>
                    <span class="dropdown-arrow" aria-hidden="true"></span>
                  </div>
                  <div class="dropdown-content"></div>
                  
                </div>
                
              </div>
              <div class="form-group">
                <label>Include Metadata</label>
                <div class="metadata-dropdown" id="includeMetadata">
                  <div
                    class="dropdown-header"
                    onclick="toggleDropdown('includeMetadata')"
                  >
                    <span>Select databases and schemas</span>
                    <span class="dropdown-arrow" aria-hidden="true"></span>
                  </div>
                  <div class="dropdown-content"></div>
                </div>
                
              </div>
            </div>

            <div class="form-group">
              <label>Exclude regex for tables & views</label>
              <input
                type="text"
                id="temp-table-regex"
                placeholder=".*_TMP|.*_TEMP"
              />
            </div>

            <div class="preflight-section">
              <div class="preflight-header">
                <h2>Preflight Checks</h2>
                <button id="runPreflightChecks" class="btn btn-primary">
                  Check
                </button>
              </div>
              <div class="preflight-content"></div>
            </div>

            <div class="bottom-bar">
              <div id="page3-nav" class="nav-buttons" style="display: none">
                <button onclick="previousPage()" class="btn btn-secondary">
                  Previous
                </button>
                <div class="action-buttons">
                  <button id="runWorkflowButton" class="btn btn-primary">
                    Run
                  </button>
                  <button id="goToResultsInline" class="btn btn-outline">
                    Go to Results
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div id="page4" class="page">
            <div class="section">
              <h2 style="font-size:1rem; font-weight:600; margin-bottom:0.5rem;">Results</h2>
              <p class="hint">Displays contents of <code>output/&lt;workflow_id&gt;/output.txt</code> once available.</p>
              <div id="resultsMeta" class="hint" style="margin-top:6px; display:none;">
                Workflow ID: <code id="workflowIdText"></code>
              </div>
              <div class="hint" style="margin-top:8px; display:flex; align-items:center; gap:8px;">
                <span>View as:</span>
                <div id="resultsViewToggle" class="view-toggle" role="tablist" aria-label="Results View">
                  <button id="viewJsonBtn" class="btn" role="tab" aria-selected="true">JSON</button>
                  <button id="viewTextBtn" class="btn btn-secondary" role="tab" aria-selected="false">Text</button>
                </div>
              </div>
            </div>

            <div id="resultsPanel" class="card" style="padding:1rem;">
              <div id="resultsLoader" class="results-loader">
                <div class="spinner-rolling"></div>
                <div><span id="resultsCountdown">10</span>s — preparing your results…</div>
              </div>
              <pre id="resultsContent" class="results-pre" style="display:none;"></pre>
              <div id="resultsSummary" class="card" style="margin-top:8px; display:none; padding:0.75rem;">
                <div style="font-weight:600; margin-bottom:6px;">Summary</div>
                <div id="resultsSummaryBody" class="hint">No summary available yet.</div>
              </div>
              <div id="resultsActions" class="results-actions" style="display:none; gap:8px;">
                <div class="actions-row actions-row-primary">
                  <button id="reloadResults" class="btn btn-secondary">Try Again</button>
                  <a id="openRawFile" href="#" target="_blank" class="btn btn-outline">Open JSON</a>
                  <a id="openSummary" href="#" target="_blank" class="btn btn-outline">Open Summary</a>
                  <a id="openDashboard" href="#" target="_blank" class="btn btn-primary">Go to Dashboard</a>
                </div>
                <div class="actions-row actions-row-secondary">
                  <div class="actions-left">
                    <label for="llmModelSelect" class="hint model-select">
                      Model
                      <select id="llmModelSelect"></select>
                    </label>
                    <button id="generateLineage" class="btn btn-outline" title="Use Groq to produce a Mermaid lineage diagram">Generate Lineage Diagram</button>
                    <button id="generateER" class="btn btn-outline" title="Use Groq to produce a Mermaid ER diagram">Generate ER Diagram</button>
                  </div>
                  <div class="actions-right">
                    <span class="hint actions-warning" title="LLM output may be inaccurate.">AI‑generated diagrams are experimental</span>
                  </div>
                </div>
              </div>
              <div id="resultsError" class="error-message" style="display:none;"></div>
            </div>

            <!-- Mermaid diagram panel -->
            <div id="mermaidPanel" class="card" style="margin-top:8px; padding:0.75rem; display:none;">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px;">
                <div style="font-weight:600;">Lineage Diagram</div>
                <div style="display:flex; gap:8px;">
                  <button id="copyMermaidBtn" class="btn btn-secondary" title="Copy Mermaid source">Copy Mermaid</button>
                </div>
              </div>
              <div id="mermaidStatus" class="hint">Click Generate to create a diagram.</div>
              <div id="mermaidError" class="error-message" style="display:none;"></div>
              <div id="mermaidContainer" class="mermaid" style="margin-top:8px; overflow:auto;"></div>
            </div>

            <!-- ER diagram panel -->
            <div id="erPanel" class="card" style="margin-top:8px; padding:0.75rem; display:none;">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px;">
                <div style="font-weight:600;">ER Diagram</div>
                <div style="display:flex; gap:8px;">
                  <button id="copyERMermaidBtn" class="btn btn-secondary" title="Copy Mermaid ER source">Copy Mermaid</button>
                </div>
              </div>
              <div id="erStatus" class="hint">Click Generate to create an ER diagram.</div>
              <div id="erError" class="error-message" style="display:none;"></div>
              <div id="erContainer" class="mermaid" style="margin-top:8px; overflow:auto;"></div>
            </div>

            <div class="bottom-bar">
              <div id="page4-nav" class="nav-buttons">
                <button onclick="previousPage()" class="btn btn-secondary">Previous</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="successModal" class="modal">
      <div class="modal-content">
        <div class="success-icon">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              fill-rule="evenodd"
              d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z"
              clip-rule="evenodd"
            />
          </svg>
        </div>
        <h2>Workflow Started Successfully!</h2>
        <p>Your workflow has been initiated and is now running.</p>
        <div class="modal-actions" style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
          <a href="http://localhost:8233/namespaces/default/workflows" class="btn btn-primary" target="_blank">Go to Dashboard</a>
          <button id="viewResultsBtn" class="btn btn-outline">View Results</button>
        </div>
      </div>
    </div>
    <script src="script.js?v=3"></script>
    <script>
      // Dismiss landing overlay to reveal the app underneath
      (function(){
        const hero = document.getElementById('landing-hero');
        const cta = document.getElementById('enter-app');
        function dismiss(e){ if(e) e.preventDefault(); if(!hero) return; hero.classList.add('hide'); setTimeout(()=>{ hero.remove(); }, 380); }
        if (cta) cta.addEventListener('click', dismiss);
        // Keyboard accessibility: Enter/Escape
        document.addEventListener('keydown', (e)=>{
          if (!hero) return;
          if (e.key === 'Enter' || e.key === 'Escape') dismiss();
        });
      })();
    </script>
  </body>
</html>
